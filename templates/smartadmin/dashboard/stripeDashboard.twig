{% extends 'smartadmin/base.html.twig' %}

{% block content %}
    <!-- BEGIN Page Content -->
    <!-- the #js-page-content id is needed for some plugins to initialize -->
    <main id="js-page-content" role="main" class="page-content">
        <ol class="breadcrumb page-breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('app_home') }}">{{ APP_NAME }}</a></li>
            <li class="breadcrumb-item active">Catch the Moon Lights</li>
            <li class="breadcrumb-item active"></li>
            <li class="position-absolute pos-top pos-right d-none d-sm-block"><span class="js-get-date"></span></li>
        </ol>
        <div class="subheader">
            <h1 class="subheader-title">
                <i class='subheader-icon fal fa-plus-circle'></i> Stripe dashboard: <span class='fw-300'> </span>
                <small>
                    opis
                </small>
            </h1>
        </div>

        {% if accountShow == false %}
            <div class="row">
                <div class="col-12 text-center">
                    <div>
                        <button class="btn btn-info mb-2" data-toggle="modal" data-target="#upload-id" style="width: 400px">Register Your Stripe Account</button><br>
                        <p class="">By registering your account, you agree to our Services Agreement and the <a target="_blank" href="https://stripe.com/en-pl/connect-account/legal/recipient">Stripe Recipient Agreement</a>.</p>
                    </div>
                </div>
                <div style="margin-top: 100px">
                    [platform name/we] use Stripe to make payouts to [account holder term, e.g., drivers or sellers]. The Stripe Recipient Agreement applies to your receipt of such Payouts. To receive payouts from [platform name/us], you must provide [platform name/us] accurate and complete information about you and your business, and you authorize [platform name/us] to share it and transaction information related to your payout with Stripe.
                </div>
            </div>
            <div class="modal fade" id="upload-id" tabindex="-1" role="dialog" style="display: none;" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">
                                Upload verification documents
                            </h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true"><i class="fal fa-times"></i></span>
                            </button>
                        </div>

                        <form action="{{ path('App_Create_Stripe_Account') }}" method="post" enctype="multipart/form-data">
                            <div class="modal-body">
                                <div class="form-group">
                                    <div class="form-group">
                                        <label class="form-label">ID card (front)</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="customFile1" name="file-front">
                                            <label class="custom-file-label text-truncate" for="customFile1">Choose ID image</label>
                                        </div>
                                        <small>An identifying document, either a passport or local ID card.</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">ID card (back)</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="customFile2" name="file-back">
                                            <label class="custom-file-label text-truncate" for="customFile2">Choose ID image</label>
                                        </div>
                                        <small>An identifying document, either a passport or local ID card.</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Additional file (front)</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="customFile3" name="address-file-front">
                                            <label class="custom-file-label text-truncate" for="customFile3">Choose ID image</label>
                                        </div>
                                        <small>A document showing address, either a passport, local ID card, or utility bill from a well-known utility company.</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Additional file (back - optional)</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="customFile4" name="address-file-back">
                                            <label class="custom-file-label text-truncate" for="customFile4">Choose ID image</label>
                                        </div>
                                        <small>A document showing address, either a passport, local ID card, or utility bill from a well-known utility company.</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Residential Region (confirmed by document above)</label>
                                        <select id="select-region" class="form-control">
                                            <option {% if user.country == "Austria" %}selected{% endif %} value="AT">Austria</option>
                                            <option {% if user.country == "Australia" %}selected{% endif %} value="AU">Australia</option>
                                            <option {% if user.country == "Belgium" %}selected{% endif %} value="BE">Belgium</option>
                                            <option {% if user.country == "Bulgaria" %}selected{% endif %} value="BG">Bulgaria</option>
                                            <option {% if user.country == "Canada" %}selected{% endif %} value="CA">Canada</option>
                                            <option {% if user.country == "Switzerland" %}selected{% endif %} value="CH">Switzerland</option>
                                            <option {% if user.country == "Cyprus" %}selected{% endif %} value="CY">Cyprus</option>
                                            <option {% if user.country == "Czech Republic" %}selected{% endif %} value="CZ">Czech Republic</option>
                                            <option {% if user.country == "Germany" %}selected{% endif %} value="DE">Germany</option>
                                            <option {% if user.country == "Denmark" %}selected{% endif %} value="DK">Denmark</option>
                                            <option {% if user.country == "Estonia" %}selected{% endif %} value="EE">Estonia</option>
                                            <option {% if user.country == "Spain" %}selected{% endif %} value="ES">Spain</option>
                                            <option {% if user.country == "Finland" %}selected{% endif %} value="FI">Finland</option>
                                            <option {% if user.country == "France" %}selected{% endif %} value="FR">France</option>
                                            <option {% if user.country == "United Kingdom" %}selected{% endif %} value="GB">Great Britan</option>
                                            <option {% if user.country == "Greece" %}selected{% endif %} value="GR">Greece</option>
                                            <option {% if user.country == "Hong Kong" %}selected{% endif %} value="HK">Hong Kong</option>
                                            <option {% if user.country == "Hungary" %}selected{% endif %} value="HU">Hungary</option>
                                            <option {% if user.country == "Ireland" %}selected{% endif %} value="IE">Ireland</option>
                                            <option {% if user.country == "India" %}selected{% endif %} value="IN">India</option>
                                            <option {% if user.country == "Italy" %}selected{% endif %} value="IT">Italy</option>
                                            <option {% if user.country == "Japan" %}selected{% endif %} value="JP">Japan</option>
                                            <option {% if user.country == "Lithuania" %}selected{% endif %} value="LT">Lithuania</option>
                                            <option {% if user.country == "Luxembourg" %}selected{% endif %} value="LU">Luxembourg</option>
                                            <option {% if user.country == "Latvia" %}selected{% endif %} value="LV">Latvia</option>
                                            <option {% if user.country == "Malta" %}selected{% endif %} value="MT">Malta</option>
                                            <option {% if user.country == "Malaysia" %}selected{% endif %} value="MY">Malaysia</option>
                                            <option {% if user.country == "Netherlands" %}selected{% endif %} value="NL">Netherlands</option>
                                            <option {% if user.country == "Norway" %}selected{% endif %} value="NO">Norway</option>
                                            <option {% if user.country == "New Zealand" %}selected{% endif %} value="NZ">New Zealand</option>
                                            <option {% if user.country == "Poland" %}selected{% endif %} value="PL">Poland</option>
                                            <option {% if user.country == "Portugal" %}selected{% endif %} value="PT">Portugal</option>
                                            <option {% if user.country == "Romania" %}selected{% endif %} value="RO">Romania</option>
                                            <option {% if user.country == "Sweden" %}selected{% endif %} value="SE">Sweden</option>
                                            <option {% if user.country == "Singapore" %}selected{% endif %} value="SG">Singapore</option>
                                            <option {% if user.country == "Slovenia" %}selected{% endif %} value="SI">Slovenia</option>
                                            <option {% if user.country == "Slovakia" %}selected{% endif %} value="SK">Slovakia</option>
                                            <option {% if user.country == "USA" %}selected{% endif%} value="USA">United States</option>
                                        </select>
                                    </div>
                                    <div class="w-100 text-center">
                                        <span class="cursor-pointer btn btn-warning btn-sm" data-toggle="modal" data-target="#upload-informations">More Information!</span>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button class="btn btn-primary">Proceed</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="upload-informations" tabindex="-1" role="dialog" style="display: none;" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content" style="width: 510px">
                        <div class="modal-header">
                            <h4 class="modal-title">
                                Upload information
                            </h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true"><i class="fal fa-times"></i></span>
                            </button>
                        </div>
                        <div class="modal-body">
                            {% include 'smartadmin/dashboard/CreateStripeAccountInformation.twig' %}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="modalHide('#upload-informations')">Close</button>
                            <button class="btn btn-primary">Proceed</button>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="row">
                <div class="col-12">
                    <h3><span class="text-black fw-900">Stripe account:</span> {{ account.id }} <sup>{{ account.individual.verification.status }}</sup></h3>
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-md-4 col-xl-3">
                            <h5>Owner - {{ account.individual.first_name }} {{ account.individual.last_name }}</h5>
                            <h5>E-mail - {{ account.email }}</h5>
                            <h5>Phone - {{ account.individual.phone }}</h5>
                            <h6 class="mt-6">Country - {{ account.country }}</h6>
                            <h6 class="">Default currency - {{ account.default_currency }}</h6>
                            <h6 class="">Payouts enabled - <span style="{% if account.payouts_enabled == true %}color: limegreen;{% else %}color: red;{% endif %}">{{ account.payouts_enabled ? 'Yes' : 'No' }}</span></h6>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-md-4 col-xl-3">
                            <h5>Line 1: {{ account.individual.address.line1 }}</h5>
                            <h5>Line 2: {{ account.individual.address.line2 }}</h5>
                            <h5>Postal Code: {{ account.individual.address.postal_code }}</h5>
                            <h5>City: {{ account.individual.address.city }}</h5>
                            <h5>State: {{ account.individual.address.state }}</h5>

                        </div>
                        <div class="col-xs-12 col-sm-6 col-md-4 col-xl-6">
                            <div class="rounded p-2" style="border: 2px solid black">
                                <p class="mt-1 w-100 text-center">Bank accounts and cards</p>
                                <button class="btn btn-outline-dark w-100" data-toggle="modal" data-target="#add-ea">Add new one</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODALS -->
            <div class="modal fade" id="add-ea" tabindex="-1" role="dialog" style="display: none;" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">
                                Add external account for payouts.
                            </h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true"><i class="fal fa-times"></i></span>
                            </button>
                        </div>

                        <form action="{{ path('App_Create_External_Account') }}" method="post">
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-6 mb-g">
                                        <label class="form-label">Country</label>
                                        <select id="select-country" class="form-control" onchange="selectForm(this.value)">
                                            <option {% if user.country == "Poland" %}selected{% else %}disabled{% endif%} value="PL">Poland</option>
                                            <option {% if user.country == "USA" %}selected{% else %}disabled{% endif%} value="USA">USA</option>
                                        </select>
                                    </div>
                                    <div class="col-6 mb-g">
                                        <label class="form-label">Currency</label>
                                        <select id="select-country" class="form-control" onchange="selectForm(this.value)">
                                            <option {% if user.country == "Poland" %}selected{% else %}disabled{% endif%} value="PL">Poland</option>
                                            <option {% if user.country == "USA" %}selected{% else %}disabled{% endif%} value="USA">USA</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group {% if user.country != "Poland" %}hidden-xs-up{% endif %}" id="PL">
                                    <label class="form-label">Account Holder Name</label><br>
                                    <input type="text" class="pl-input input form-control mb-2" {% if user.country != "Poland" %}disabled{% endif %} value="{{ user.FirstName }} {{ user.LastName }}" name="account_holder_name">
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <label class="form-label">Currency</label>
                                                <input type="text" class="pl-input input form-control" {% if user.country != "Poland" %}disabled{% endif %} value="pln" name="currency">
                                            </div>
                                        </div>
                                    <label class="form-label">Account Number</label>
                                    <input type="text" class="pl-input input form-control" {% if user.country != "Poland" %}disabled{% endif %} placeholder="Account number" name="acc_number">
                                </div>
                                <div class="form-group {% if user.country != "USA" %}hidden-xs-up{% endif %}" id="USA">
                                    <label class="form-label">Account Holder Name</label><br>
                                    <input type="text" class="usa-input input form-control mb-2" {% if user.country != "USA" %}disabled{% endif %} value="{{ user.FirstName }} {{ user.LastName }}" name="account_holder_name">
                                    <div class="row mb-2">
                                        <div class="col-6">
                                            <label class="form-label">Routing Number</label>
                                            <input type="text" class="usa-input input form-control" {% if user.country != "USA" %}disabled{% endif %} name="country">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Currency</label>
                                            <input type="text" class="usa-input input form-control" {% if user.country != "USA" %}disabled{% endif %} value="pln" name="currency">
                                        </div>
                                    </div>
                                    <label class="form-label">Account Number</label>
                                    <input type="text" class="usa-input input form-control" {% if user.country != "USA" %}disabled{% endif %} placeholder="Account number" name="acc_number">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button class="btn btn-primary">Proceed</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endif %}
    </main>
    <!-- this overlay is activated only when mobile menu is triggered -->
    <div class="page-content-overlay" data-action="toggle" data-class="mobile-nav-on"></div> <!-- END Page Content -->
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>/**
 * The CSS shown here will not be introduced in the Quickstart guide, but shows
 * how you can use CSS to style your Element's container.
 */
        .StripeElement {
            box-sizing: border-box;

            height: 40px;

            padding: 10px 12px;

            border: 1px solid transparent;
            border-radius: 4px;
            background-color: white;

            box-shadow: 0 1px 3px 0 #e6ebf1;
            -webkit-transition: box-shadow 150ms ease;
            transition: box-shadow 150ms ease;
        }

        .StripeElement--focus {
            box-shadow: 0 1px 3px 0 #cfd7df;
        }

        .StripeElement--invalid {
            border-color: #fa755a;
        }

        .StripeElement--webkit-autofill {
            background-color: #fefde5 !important;}
    </style>
{% endblock %}

{%  block leftMenu %}
    {% include 'smartadmin/parts/leftMenu.html.twig' %}
{% endblock %}

{% block header %}
    {% include 'smartadmin/parts/header.html.twig' %}
{% endblock %}

{% block footer %}
    {% include 'smartadmin/parts/footer.twig' %}
{%  endblock %}

{% block quickmenu %}
    {% include 'smartadmin/parts/quickmenu.twig' %}
{% endblock %}

{% block messenger %}
    {% include 'smartadmin/parts/chat.twig' %}
{% endblock %}

{% block pagesettings %}
    {% include 'smartadmin/parts/pagesettings.twig' %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        let basketitems = 0;
        let basketmoons = 0;
        let total = 0;
        function addToBasket(id, price){
            basketitems = basketitems + 1;
            total = total+price;
            basketmoons = basketmoons + id;
            $('#target-basket').append(id+" moon lights for "+price+" zł <br>")

            $('#target-total').html(basketmoons + " Moon Lights for " + total + " zł")
            $('#target-total-pay').text("Submit Payment: " + total + " zł")
            $('#target-total-val').val(total)
            $('#target-products').append('<input type="hidden" name="item-'+basketitems+'" value="'+id+'" id="target-item-'+basketitems+'">')
            $('#target-products-count').html('<input type="hidden" name="items-count" value="'+basketitems+'" id="target-items-count">')
        }
    </script>
    <script type="text/javascript">// Create a Stripe client.
        var stripe = Stripe('{{ stripe_public_key }}');

        // Create an instance of Elements.
        var elements2 = stripe.elements();

        // Custom styling can be passed to options when creating an Element.
        // (Note that this demo uses a wider set of styles than the guide below.)
        var style = {
            base: {
                color: '#32325d',
                fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                fontSmoothing: 'antialiased',
                fontSize: '16px',
                '::placeholder': {
                    color: '#aab7c4'
                }
            },
            invalid: {
                color: '#fa755a',
                iconColor: '#fa755a'
            }
        };

        // Create an instance of the card Element.
        var card = elements2.create('card', {style: style});

        // Add an instance of the card Element into the `card-element` <div>.
        card.mount('#card-element');
        // Handle real-time validation errors from the card Element.
        card.on('change', function(event) {
            var displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });

        // Handle form submission.
        var form = document.getElementById('payment-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            stripe.createToken(card).then(function(result) {
                if (result.error) {
                    // Inform the user if there was an error.
                    var errorElement = document.getElementById('card-errors');
                    errorElement.textContent = result.error.message;
                } else {
                    // Send the token to your server.
                    stripeTokenHandler(result.token);
                }
            });
        });

        // Submit the form with the token ID.
        function stripeTokenHandler(token) {
            // Insert the token ID into the form so it gets submitted to the server
            var form = document.getElementById('payment-form');
            var hiddenInput = document.createElement('input');
            hiddenInput.setAttribute('type', 'hidden');
            hiddenInput.setAttribute('name', 'stripeToken');
            hiddenInput.setAttribute('value', token.id);
            form.appendChild(hiddenInput);

            // Submit the form
            form.submit();
        }
    </script>
    <script>
        {% if user.country == "Poland" %}
            let selected = 'PL'
        {% else %}
            let selected = ''
        {% endif %}
        function selectForm(value){
            $('#'+selected).addClass('hidden-xs-up')

            $('#'+value).removeClass('hidden-xs-up')

            $('.input').attr('disabled', true)
            if (value === "USA"){
                $('.usa-input').removeAttr('disabled')
            } else if (value === "PL") {
                $('.pl-input').removeAttr('disabled')
            }

            selected = value
            console.log(value)
        }
    </script>
    <script>
        function modalHide(id){
            $(id).modal('hide');
        }
    </script>
{% endblock %}